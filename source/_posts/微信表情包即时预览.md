title: 微信表情包即时预览
date: 2015-08-20 00:42:17
tags: [qq表情,微信预览]
---

### 文本消息
首先我们了解一下微信的后台发消息机制，主要我们开发用到的就是发送

 - 文本消息(带表情符号)
 - 图文消息
 - 图片
 
领导让我们做个企业号后台和微信自带的那个最好一样的，那就做吧。
本篇我们主要讲文本消息中的那个表情符号，和字长限制。
<!-- more -->
### 1.表情符号
有必要先去了解一下表情机制，这里推荐阅读了解:
 - [微信公众帐号开发教程第11篇-符号表情的发送（上）](http://blog.csdn.net/lyq8479/article/details/9229637)
 - [微信公众帐号开发教程第12篇-符号表情的发送（上）](http://blog.csdn.net/lyq8479/article/details/9393097)

准备阶段，把表情包全下载下来，把命名从`1`开始，随自己喜欢，后面很简单取到图片的名称，页面编写,略过吧。
### 2.部分代码分析
怎么简单怎么写，也不用做映射了：
```javascript
var emoji_cn=['[微笑]','[撇嘴]','[色]','[发呆]','[得意]','[流泪]','[害羞]','[闭嘴]','[睡]','[大哭]','[尴尬]','[发怒]','[调皮]','[呲牙]','[惊讶]','[难过]','[酷]','[冷汗]','[折磨]','[吐]','[偷笑]','[可爱]','[白眼]','[傲慢]','[饥饿]','[困]','[惊恐]','[流汗]','[憨笑]','[大兵]','[奋斗]','[咒骂]','[疑问]','[嘘]','[晕]','[抓狂]','[衰]','[骷髅]','[敲打]','[再见]','[擦汗]','[抠鼻]','[鼓掌]','[溴大了]','[坏笑]','[左哼哼]','[右哼哼]','[哈欠]','[鄙视]','[委屈]','[快哭了]','[阴险]','[亲亲]','[吓]','[可怜]','[菜刀]','[西瓜]','[啤酒]','[篮球]','[乒乓]','[咖啡]','[饭]','[猪头]','[玫瑰]','[凋谢]','[嘴唇]','[爱心]','[心碎]','[蛋糕]','[闪电]','[炸弹]','[刀]','[足球]','[瓢虫]','[便便]','[月亮]','[太阳]','[礼物]','[拥抱]','[强]','[弱]','[握手]','[胜利]','[抱拳]','[勾引]','[拳头]','[差劲]','[爱你]','[NO]','[YES]','[爱情]','[飞吻]','[跳跳]','[发抖]','[怄火]','[转圈]','[磕头]','[回头]','[跳绳]','[挥手]','[激动]','[街舞]','[献吻]','[左太极]','[右太极]'];
```
先把编码全部放到一个数组中，按顺序。要么你就存一个对象一个编码对应图片的地址名称，然后显示的时候，直接替换就行，这种比较简单。同事简单做了个，就用这个规则了。
想一下我们要的效果是，点击表情，显示所有的表情，官方那用的是一个切图，然后放热点，当然也可以匹配做成动态的，ok我们也这么干。没什么问题。热点点击的时候，把对应图片的编码放到输入的文本框中。
```javascript
$(".em_nr a").click(function(){
	var data_image = $(this).data("image");
	$("#saytext").val($("#saytext").val()+ "[" + this.title + "]");
});
```
然后我们可以做动态显示了
```javascript
//在数组中查找输入的字符串是否含有表情编码，有就替换成图片表情返回预览
//如果是数组对象，做个映射，我们直接遍历就能取出图片地址名称了，也不用自己去给图片编个名字，省不少事情，霸王硬上弓，先了解了解。
    function replace_img(str){
    		for(var i=0;i<emoji_cn.length;i++){
    			str = str.replace(eval('/\\'+emoji_cn[i]+'/g'),'<img src="face/'+(i+1)+'.gif" border="0" />');	
    		}
    		return str;
    	}
//文本框change事件，右边同步预览
	$('#saytext').bind('input propertychange', function () {
		var str =$("#saytext").val();
		$("#show").html(replace_img(str));
	});
```
文本框改变直接显示输入的结果，这种用 `angularjs` 的数据模型绑定非常方便。这个地方没有用，纯属练手看原生`js`怎么实现的，在图文消息部分我们用 `angularjs`做预览就非常方便了，如果再用 `jquery` 去写代码，不知道要写多少，还不一定能好实现，有时间把图文预览那块总结发个 `demo` 上来。
----------

### 3.Angularjs实现方式以及优化
把数据重新组了一下，少了不少代码，被新来的同事整的细碎。
#### html代码
```html	
<div ng-app="appDemo" ng-controller="EmojiDemo">
	<textarea name="" id="" cols="30" rows="10" ng-model="emojStr"></textarea>
	<input type="text" >
	<div id="replaceStr"></div>
	{{$scope.targetStr}}
</div>
```
#### 简单js
```javascript
	//1.制造数组对象
	//首先执行这个方法，把我们上次的代码，整合成一个数组json对象，这样:var _emoji= [{"emojCode":"[微笑]","target":"1.gif"},{"emojCode":"[撇嘴]","target":"2.gif"}···];
	//由于图片的命名是有规则的,所以我们直接按照规则办事，直接就映射上了，不用那么笨的去对应index，另外手动去编写这个字符串不得累死105个呢
	function createEmojiObj(){
				var emoji_=[];
				var emoji_cn1=['[微笑]','[撇嘴]','[色]','[发呆]','[得意]','[流泪]','[害羞]','[闭嘴]','[睡]','[大哭]','[尴尬]','[发怒]','[调皮]','[呲牙]','[惊讶]','[难过]','[酷]','[冷汗]','[折磨]','[吐]','[偷笑]','[可爱]','[白眼]','[傲慢]','[饥饿]','[困]','[惊恐]','[流汗]','[憨笑]','[大兵]','[奋斗]','[咒骂]','[疑问]','[嘘]','[晕]','[抓狂]','[衰]','[骷髅]','[敲打]','[再见]','[擦汗]','[抠鼻]','[鼓掌]','[溴大了]','[坏笑]','[左哼哼]','[右哼哼]','[哈欠]','[鄙视]','[委屈]','[快哭了]','[阴险]','[亲亲]','[吓]','[可怜]','[菜刀]','[西瓜]','[啤酒]','[篮球]','[乒乓]','[咖啡]','[饭]','[猪头]','[玫瑰]','[凋谢]','[嘴唇]','[爱心]','[心碎]','[蛋糕]','[闪电]','[炸弹]','[刀]','[足球]','[瓢虫]','[便便]','[月亮]','[太阳]','[礼物]','[拥抱]','[强]','[弱]','[握手]','[胜利]','[抱拳]','[勾引]','[拳头]','[差劲]','[爱你]','[NO]','[YES]','[爱情]','[飞吻]','[跳跳]','[发抖]','[怄火]','[转圈]','[磕头]','[回头]','[跳绳]','[挥手]','[激动]','[街舞]','[献吻]','[左太极]','[右太极]'];
				$.each(emoji_cn1,function(i){
					j=i+1;
					emoji_.push({emojCode:emoji_cn1[i],target:j+'.gif'});
				})
				//document.write(JSON.stringify(emoji_))
				return emoji_;
			}
		}) ;
	//2:angularjs实现
	//jquery 实现最简单，都是循环数组，把输入的字符串中有头像code替换成对应的图片
	//字符串转html,并没有用指令去实现或者直接用ng-bindhtml，没必要那么折磨自己，直接jQuery的html()方法就好了
	var _modul=angular.module('appDemo',[]);
	_modul.controller('EmojiDemo',function($scope){
		$scope.emojStr="look here[微笑][微笑][微笑][微笑]";
		$scope.targetStr="";
		var _emoji= createEmojiObj();//可以直接定义出来，没必要浪费效率
		var watch=$scope.$watch('emojStr',function(newValue,oldValue){
			$.each(_emoji,function(i,value){
				if(newValue.indexOf(value.emojCode)>=0){
					newValue=newValue.replace(eval('/\\'+value.emojCode+'/g'),'<img src="face/'+value.target+'"/>');	
				}
			});
			$scope.targetStr=newValue;
			jQuery('#replaceStr').html(newValue);
		});//end watch
	});
```
### 4.预览
知道大家都喜欢干货哈，在这里：
 - 源码在这里：[github](https://github.com/chanzig/myDemolib/tree/gh-pages/wechat_face)
 - 预览在这里：[微信表情包即时预览](http://chanzig.github.io/myDemolib/wechat_face/)

 
